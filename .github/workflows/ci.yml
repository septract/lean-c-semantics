name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgmp-dev opam

      - name: Install cvc5 SMT solver
        run: |
          wget -q https://github.com/cvc5/cvc5/releases/download/cvc5-1.3.2/cvc5-Linux-x86_64-static.zip
          unzip -q cvc5-Linux-x86_64-static.zip
          sudo mv cvc5-Linux-x86_64-static/bin/cvc5 /usr/local/bin/
          rm -rf cvc5-Linux-x86_64-static cvc5-Linux-x86_64-static.zip
          cvc5 --version

      - name: Setup Lean
        uses: leanprover/lean-action@v1
        with:
          build: false
          test: false
          lake-package-directory: lean

      - name: Restore OPAM cache
        uses: actions/cache@v4
        with:
          path: ~/.opam
          key: opam-cerberus-414-${{ hashFiles('cerberus/cerberus-lib.opam', 'cerberus/cerberus.opam') }}

      - name: Initialize Opam
        run: opam init -y --disable-sandboxing

      - name: Setup Cerberus
        run: make cerberus-setup

      - name: Build and test
        run: make ci
